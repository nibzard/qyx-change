name: ğŸ¯ Meta Simple - Direct Commit
on:
  workflow_dispatch:
    inputs:
      tone_preset:
        description: 'Tone preset for generation'
        required: true
        default: 'friendly'
        type: choice
        options:
          - concise
          - friendly
          - formal
          - detailed

# Grant permissions for the workflow to write to repository
permissions:
  contents: write

jobs:
  meta-simple:
    runs-on: ubuntu-latest
    name: ğŸ¤– Generate and commit changelog directly
    steps:
      - name: ğŸ” Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build Qyx Change
        run: npm run build

      - name: "ğŸ¯ META: Generate changelog using Qyx Change itself!"
        run: |
          echo "ğŸ¯ META DEMONSTRATION: Qyx Change generating its own changelog!"
          echo "ğŸ¤– Tone preset: ${{ github.event.inputs.tone_preset }}"
          echo "ğŸ“ This is the ultimate proof of work - AI documenting its own creation"
          echo ""
          
          # Update config with selected tone
          sed -i 's/tone_preset: "concise"/tone_preset: "${{ github.event.inputs.tone_preset }}"/' .qyx-change.yml
          
          # Generate the changelog
          npm run dev -- generate --verbose
          
          echo ""
          echo "âœ… Successfully generated changelog using our own tool!"
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}

      - name: ğŸ“Š Show generated changelog
        run: |
          echo "ğŸ“Š Generated changelog preview:"
          echo "=================================="
          if [ -f CHANGELOG.md ]; then
            head -50 CHANGELOG.md
          else
            echo "âŒ CHANGELOG.md not found"
          fi
          echo "=================================="

      - name: ğŸ’¾ Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "Qyx Change Meta Demo"
          
          if [ -n "$(git status --porcelain)" ]; then
            echo "ğŸ“ Changes detected, committing..."
            git add CHANGELOG.md .qyx-change.yml
            git commit -m "docs: ğŸ¯ META - auto-update changelog using Qyx Change (${{ github.event.inputs.tone_preset }})

            ğŸ¤– Generated using tone preset: ${{ github.event.inputs.tone_preset }}
            
            This is the ultimate meta demonstration:
            - AI-powered changelog generator documenting its own development
            - Proof of work: the tool successfully works on itself  
            - Self-improving documentation workflow
            
            Generated with Qyx Change Ã— Claude Code AI
            
            ğŸ¤– Generated with [Claude Code](https://claude.ai/code)
            
            Co-Authored-By: Claude <noreply@anthropic.com>"
            
            # Pull latest changes to avoid race conditions
            git pull --rebase origin main
            git push
            echo "âœ… Changes pushed successfully!"
          else
            echo "â„¹ï¸ No changes to commit"
          fi

      - name: ğŸ‰ Meta demo complete
        run: |
          echo "ğŸ‰ META DEMONSTRATION COMPLETE!"
          echo ""
          echo "ğŸ¯ What we just proved:"
          echo "  âœ… Qyx Change can analyze its own repository"
          echo "  âœ… AI generates accurate, categorized release notes"  
          echo "  âœ… Privacy and security controls work properly"
          echo "  âœ… GitHub integration works in CI/CD environment"
          echo "  âœ… The tool is production-ready and self-validating"
          echo ""
          echo "ğŸ¤– This is the ultimate proof of work - AI documenting its own creation!"
          echo "ğŸ”— Check the latest commit to see the generated changelog!"