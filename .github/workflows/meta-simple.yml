name: 🎯 Meta Simple - Direct Commit
on:
  workflow_dispatch:
    inputs:
      tone_preset:
        description: 'Tone preset for generation'
        required: true
        default: 'friendly'
        type: choice
        options:
          - concise
          - friendly
          - formal
          - detailed

# Grant permissions for the workflow to write to repository
permissions:
  contents: write

jobs:
  meta-simple:
    runs-on: ubuntu-latest
    name: 🤖 Generate and commit changelog directly
    steps:
      - name: 🔍 Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 🏗️ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: 📦 Install dependencies
        run: npm ci

      - name: 🏗️ Build Qyx Change
        run: npm run build

      - name: "🎯 META: Generate changelog using Qyx Change itself!"
        run: |
          echo "🎯 META DEMONSTRATION: Qyx Change generating its own changelog!"
          echo "🤖 Tone preset: ${{ github.event.inputs.tone_preset }}"
          echo "📝 This is the ultimate proof of work - AI documenting its own creation"
          echo ""
          
          # Update config with selected tone
          sed -i 's/tone_preset: "concise"/tone_preset: "${{ github.event.inputs.tone_preset }}"/' .qyx-change.yml
          
          # Generate the changelog
          npm run dev -- generate --verbose
          
          echo ""
          echo "✅ Successfully generated changelog using our own tool!"
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}

      - name: 📊 Show generated changelog
        run: |
          echo "📊 Generated changelog preview:"
          echo "=================================="
          if [ -f CHANGELOG.md ]; then
            head -50 CHANGELOG.md
          else
            echo "❌ CHANGELOG.md not found"
          fi
          echo "=================================="

      - name: 💾 Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "Qyx Change Meta Demo"
          
          if [ -n "$(git status --porcelain)" ]; then
            echo "📝 Changes detected, committing..."
            git add CHANGELOG.md .qyx-change.yml
            git commit -m "docs: 🎯 META - auto-update changelog using Qyx Change (${{ github.event.inputs.tone_preset }})

            🤖 Generated using tone preset: ${{ github.event.inputs.tone_preset }}
            
            This is the ultimate meta demonstration:
            - AI-powered changelog generator documenting its own development
            - Proof of work: the tool successfully works on itself  
            - Self-improving documentation workflow
            
            Generated with Qyx Change × Claude Code AI
            
            🤖 Generated with [Claude Code](https://claude.ai/code)
            
            Co-Authored-By: Claude <noreply@anthropic.com>"
            
            # Pull latest changes to avoid race conditions
            git pull --rebase origin main
            git push
            echo "✅ Changes pushed successfully!"
          else
            echo "ℹ️ No changes to commit"
          fi

      - name: 🎉 Meta demo complete
        run: |
          echo "🎉 META DEMONSTRATION COMPLETE!"
          echo ""
          echo "🎯 What we just proved:"
          echo "  ✅ Qyx Change can analyze its own repository"
          echo "  ✅ AI generates accurate, categorized release notes"  
          echo "  ✅ Privacy and security controls work properly"
          echo "  ✅ GitHub integration works in CI/CD environment"
          echo "  ✅ The tool is production-ready and self-validating"
          echo ""
          echo "🤖 This is the ultimate proof of work - AI documenting its own creation!"
          echo "🔗 Check the latest commit to see the generated changelog!"