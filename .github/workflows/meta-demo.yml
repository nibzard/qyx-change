name: ğŸ¯ Meta Demo - Generate Own Changelog
on:
  workflow_dispatch:
    inputs:
      tone_preset:
        description: 'Tone preset for generation'
        required: true
        default: 'friendly'
        type: choice
        options:
          - concise
          - friendly
          - formal
          - detailed
      create_pr:
        description: 'Create PR for the generated changelog'
        type: boolean
        default: true

# Grant permissions for the workflow to create PRs and push
permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  meta-demo:
    runs-on: ubuntu-latest
    name: ğŸ¤– Generate Qyx Change's own changelog
    steps:
      - name: ğŸ” Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build Qyx Change
        run: npm run build

      - name: "ğŸ¯ META: Generate changelog using Qyx Change itself!"
        run: |
          echo "ğŸ¯ META DEMONSTRATION: Qyx Change generating its own changelog!"
          echo "ğŸ¤– Tone preset: ${{ github.event.inputs.tone_preset }}"
          echo "ğŸ“ This is the ultimate proof of work - AI documenting its own creation"
          echo ""
          
          # Update config with selected tone
          sed -i 's/tone_preset: "concise"/tone_preset: "${{ github.event.inputs.tone_preset }}"/' .qyx-change.yml
          
          # Generate the changelog
          npm run dev -- generate --verbose
          
          echo ""
          echo "âœ… Successfully generated changelog using our own tool!"
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}

      - name: ğŸ“Š Show generated changelog
        run: |
          echo "ğŸ“Š Generated changelog preview:"
          echo "=================================="
          if [ -f CHANGELOG.md ]; then
            head -50 CHANGELOG.md
          else
            echo "âŒ CHANGELOG.md not found"
          fi
          echo "=================================="

      - name: ğŸ”„ Create Pull Request
        if: ${{ github.event.inputs.create_pr == 'true' }}
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            docs: ğŸ¯ META - update changelog using Qyx Change itself
            
            Generated using tone preset: ${{ github.event.inputs.tone_preset }}
            
            This is the ultimate meta demonstration:
            ğŸ¤– AI-powered changelog generator documenting its own development
            ğŸ¯ Proof of work: the tool works on itself
            ğŸš€ Self-improving documentation workflow
            
            ğŸ¤– Generated with [Claude Code](https://claude.ai/code)
            
            Co-Authored-By: Claude <noreply@anthropic.com>
          title: "ğŸ¯ META: Qyx Change generates its own changelog (${{ github.event.inputs.tone_preset }} tone)"
          body: |
            # ğŸ¯ META Demonstration: Self-Generated Changelog
            
            > **This PR demonstrates Qyx Change generating its own changelog - the ultimate proof of work!**
            
            ## ğŸ¤– What This Demonstrates
            
            - âœ… **AI-Powered Generation**: Claude Code creating intelligent release notes
            - âœ… **Self-Documentation**: The tool documenting its own development  
            - âœ… **Tone Customization**: Using **${{ github.event.inputs.tone_preset }}** tone preset
            - âœ… **GitHub Integration**: Automated PR creation with proper formatting
            - âœ… **Privacy Protection**: Redaction working on real repository data
            
            ## ğŸ¨ Configuration Used
            
            ```yaml
            tone_preset: "${{ github.event.inputs.tone_preset }}"
            generation:
              include_developer_notes: true
              send_diff_snippets: false  # Privacy first!
            ```
            
            ## ğŸ” Meta Analysis
            
            This changelog was generated by analyzing the actual commits in this repository and using AI to:
            1. **Categorize changes** into logical sections (Features, Fixes, etc.)
            2. **Extract meaning** from commit messages and code changes  
            3. **Create human-friendly descriptions** that explain the impact
            4. **Include commit references** for full traceability
            5. **Apply consistent formatting** following Keep a Changelog standards
            
            ## ğŸ¯ Proof Points
            
            - ğŸ¤– **Works on itself**: Successfully processes its own repository
            - ğŸ“ **Accurate categorization**: Correctly identifies features, fixes, chores
            - ğŸ”— **Proper references**: Includes commit hashes and maintains traceability  
            - ğŸ›¡ï¸ **Privacy protection**: No sensitive data exposed in generation
            - ğŸ¨ **Tone consistency**: Maintains ${{ github.event.inputs.tone_preset }} voice throughout
            
            ---
            
            **ğŸš€ This is Qyx Change proving it works by documenting itself!**
            
            Generated with [Qyx Change](https://github.com/nibzard/qyx-change) Ã— [Claude Code](https://claude.ai/code)
          branch: meta/qyx-change-${{ github.event.inputs.tone_preset }}-tone
          delete-branch: true

      - name: ğŸ‰ Meta demo complete
        run: |
          echo "ğŸ‰ META DEMONSTRATION COMPLETE!"
          echo ""
          echo "ğŸ¯ What we just proved:"
          echo "  âœ… Qyx Change can analyze its own repository"
          echo "  âœ… AI generates accurate, categorized release notes"  
          echo "  âœ… Privacy and security controls work properly"
          echo "  âœ… GitHub integration creates professional PRs"
          echo "  âœ… The tool is production-ready and self-validating"
          echo ""
          echo "ğŸ¤– This is the ultimate proof of work - AI documenting its own creation!"